<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>股票监控系统</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css"
    />
    <style>
      :root {
        --primary-color: #3f51b5;
        --primary-light: #757de8;
        --primary-dark: #002984;
        --secondary-color: #f44336;
        --secondary-light: #ff7961;
        --secondary-dark: #ba000d;
        --success-color: #4caf50;
        --warning-color: #ff9800;
        --text-primary: #212121;
        --text-secondary: #757575;
        --bg-color: #f5f7fa;
        --card-bg: #ffffff;
        --border-color: #e0e0e0;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        padding: 0;
        background-color: var(--bg-color);
        color: var(--text-primary);
      }

      .header {
        background-color: var(--primary-color);
        color: white;
        padding: 1.5rem 0;
        margin-bottom: 2rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .header h1 {
        margin: 0;
        font-size: 1.8rem;
        font-weight: 600;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 15px;
      }

      .section {
        background-color: var(--card-bg);
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        padding: 1.5rem;
        margin-bottom: 2rem;
      }

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid var(--border-color);
      }

      .section-title {
        font-size: 1.4rem;
        font-weight: 600;
        color: var(--primary-color);
        margin: 0;
      }

      .form-row {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 1.25rem;
        margin-bottom: 1.5rem;
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        align-items: center;
      }

      .form-group {
        display: flex;
        align-items: center;
        flex: 1;
        min-width: 200px;
      }

      .form-label {
        font-size: 0.9rem;
        font-weight: 500;
        margin-right: 0.75rem;
        color: var(--text-secondary);
        white-space: nowrap;
      }

      .form-input {
        flex: 1;
        padding: 0.5rem 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-size: 0.9rem;
        transition: border-color 0.2s;
      }

      .form-input:focus {
        outline: none;
        border-color: var(--primary-light);
        box-shadow: 0 0 0 2px rgba(63, 81, 181, 0.2);
      }

      .btn {
        padding: 0.5rem 1.25rem;
        border: none;
        border-radius: 4px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
      }

      .btn-primary {
        background-color: var(--primary-color);
        color: white;
      }

      .btn-primary:hover {
        background-color: var(--primary-dark);
      }

      .btn-danger {
        background-color: var(--secondary-color);
        color: white;
      }

      .btn-danger:hover {
        background-color: var(--secondary-dark);
      }

      .btn-success {
        background-color: var(--success-color);
        color: white;
      }

      .btn-success:hover {
        background-color: #388e3c;
      }

      .btn-warning {
        background-color: var(--warning-color);
        color: white;
      }

      .btn-warning:hover {
        background-color: #f57c00;
      }

      table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        margin-bottom: 1rem;
      }

      th,
      td {
        padding: 0.75rem 1rem;
        text-align: center;
        border-bottom: 1px solid var(--border-color);
      }

      th {
        background-color: #f8f9fa;
        font-weight: 600;
        color: var(--text-secondary);
        position: sticky;
        top: 0;
        z-index: 10;
      }

      th:first-child {
        border-top-left-radius: 8px;
      }

      th:last-child {
        border-top-right-radius: 8px;
      }

      tbody tr:hover {
        background-color: rgba(0, 0, 0, 0.02);
      }

      .table-container {
        max-height: 500px;
        overflow-y: auto;
        border-radius: 8px;
        border: 1px solid var(--border-color);
      }

      .negative {
        color: var(--success-color);
        font-weight: 500;
      }

      .positive {
        color: var(--secondary-color);
        font-weight: 500;
      }

      .action-btn {
        padding: 0.35rem 0.75rem;
        margin: 0 0.25rem;
        border: 1px solid var(--primary-color);
        background-color: white;
        color: var(--primary-color);
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.85rem;
        transition: all 0.2s;
      }

      .action-btn:hover {
        background-color: var(--primary-color);
        color: white;
      }

      .delete-btn {
        border-color: var(--secondary-color);
        color: var(--secondary-color);
      }

      .delete-btn:hover {
        background-color: var(--secondary-color);
        color: white;
      }

      .monitor-price-input {
        width: 80px;
        text-align: center;
        padding: 0.35rem;
        border: 1px solid var(--border-color);
        border-radius: 4px;
      }

      .note {
        background-color: #e8eaf6;
        border-radius: 8px;
        padding: 1rem 1.5rem;
        margin-top: 2rem;
        color: var(--text-secondary);
        border-left: 4px solid var(--primary-color);
      }

      .note p:first-child {
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: var(--primary-color);
      }

      .badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 500;
      }

      .badge-success {
        background-color: rgba(76, 175, 80, 0.1);
        color: var(--success-color);
      }

      .badge-warning {
        background-color: rgba(255, 152, 0, 0.1);
        color: var(--warning-color);
      }

      .badge-danger {
        background-color: rgba(244, 67, 54, 0.1);
        color: var(--secondary-color);
      }

      .system-controls {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
      }

      .status-indicator {
        display: inline-flex;
        align-items: center;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        font-weight: 500;
        margin-left: auto;
      }

      .status-running {
        background-color: rgba(76, 175, 80, 0.1);
        color: var(--success-color);
      }

      .status-stopped {
        background-color: rgba(244, 67, 54, 0.1);
        color: var(--secondary-color);
      }

      @media (max-width: 768px) {
        .form-row {
          flex-direction: column;
          align-items: stretch;
        }

        .form-group {
          margin-bottom: 0.75rem;
        }

        .table-container {
          overflow-x: auto;
        }

        .system-controls {
          flex-direction: column;
        }

        .status-indicator {
          margin-left: 0;
          margin-top: 0.5rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="header">
      <div class="container">
        <h1><i class="bi bi-graph-up"></i> 股票监控系统</h1>
      </div>
    </div>

    <div class="container">
      <!-- 系统控制部分 -->
      <div class="section">
        <div class="section-header">
          <h2 class="section-title"><i class="bi bi-gear"></i> 系统控制</h2>
          <div id="systemStatus" class="status-indicator status-stopped">
            <i class="bi bi-circle-fill"></i>
            <span>系统状态: 未运行</span>
          </div>
        </div>

        <div class="system-controls">
          <button id="startBtn" class="btn btn-success">
            <i class="bi bi-play-fill"></i> 启动监控
          </button>
          <button id="stopBtn" class="btn btn-danger" disabled>
            <i class="bi bi-stop-fill"></i> 停止监控
          </button>
        </div>
      </div>

      <!-- 监控股票价格部分 -->
      <div class="section">
        <div class="section-header">
          <h2 class="section-title">
            <i class="bi bi-currency-yen"></i> 监控股票价格
          </h2>
        </div>

        <div class="form-row">
          <div class="form-group">
            <span class="form-label">股票代码</span>
            <input
              type="text"
              id="stockCode"
              class="form-input"
              placeholder="输入股票代码"
            />
          </div>
          <div class="form-group">
            <span class="form-label">股票名称</span>
            <input
              type="text"
              id="stockName"
              class="form-input"
              placeholder="输入股票名称"
            />
          </div>
          <div class="form-group">
            <span class="form-label">监控价格</span>
            <input
              type="number"
              id="monitorPrice"
              class="form-input"
              placeholder="输入监控价格"
              step="0.01"
            />
          </div>
          <div class="form-group">
            <span class="form-label">备注标签</span>
            <input
              type="text"
              id="stockNote"
              class="form-input"
              placeholder="输入备注标签（可选）"
            />
          </div>
          <button id="addStockBtn" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> 添加
          </button>
        </div>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>股票名称</th>
                <th>昨日涨幅</th>
                <th>昨日收盘价</th>
                <th>今日涨幅</th>
                <th>当前价格</th>
                <th>监控价格</th>
                <th>备注</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="stockTableBody">
              <!-- 数据将通过 JavaScript 动态填充 -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- 监控均线价格部分 -->
      <div class="section">
        <div class="section-header">
          <h2 class="section-title">
            <i class="bi bi-bar-chart-line"></i> 监控均线价格
          </h2>
        </div>

        <div class="form-row">
          <div class="form-group">
            <span class="form-label">股票代码</span>
            <input
              type="text"
              id="maStockCode"
              class="form-input"
              placeholder="输入股票代码"
            />
          </div>
          <div class="form-group">
            <span class="form-label">股票名称</span>
            <input
              type="text"
              id="maStockName"
              class="form-input"
              placeholder="输入股票名称"
            />
          </div>
          <div class="form-group">
            <span class="form-label">备注标签</span>
            <input
              type="text"
              id="maStockNote"
              class="form-input"
              placeholder="输入备注标签（可选）"
            />
          </div>
          <button id="addMaStockBtn" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> 添加
          </button>
        </div>

        <div class="table-container">
          <table id="maStockTable">
            <thead>
              <tr>
                <th>股票名称</th>
                <th>主力净量</th>
                <th>昨日涨幅</th>
                <th>开盘价</th>
                <th>收盘价</th>
                <th>换手率</th>
                <th>5日均价</th>
                <th>10日均价</th>
                <th>距离5日均价</th>
                <th>当前价格</th>
                <th>备注</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="maStockList">
              <!-- 均线监控数据将通过JavaScript动态添加 -->
            </tbody>
          </table>
        </div>
      </div>

      <div class="note">
        <p><i class="bi bi-info-circle"></i> 说明</p>
        <p>
          1.
          价格监控：当股票价格低于设定的监控价格时，系统会自动发送预警消息到企业微信群。
        </p>
        <p>
          2.
          均线监控：当股票价格低于5日均线或10日均线时，系统会自动发送预警消息到企业微信群。
        </p>
        <p>
          3. 交易时间（9:30-11:30,
          13:00-15:00）内，系统每30秒自动检查一次股票价格。
        </p>
        <p>4. 备注标签：添加备注标签后，发送预警消息时会包含该标签信息。</p>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // 全局变量
      let monitoring = false;
      let stocks = [];
      let maStocks = [];
      let updateInterval;

      // 页面加载完成后执行
      document.addEventListener("DOMContentLoaded", function () {
        // 获取监控状态
        fetchMonitorStatus();

        // 获取股票数据
        fetchStocks();
        fetchMaStocks();

        // 绑定按钮事件
        document
          .getElementById("startBtn")
          .addEventListener("click", startMonitoring);
        document
          .getElementById("stopBtn")
          .addEventListener("click", stopMonitoring);
        document
          .getElementById("addStockBtn")
          .addEventListener("click", addStock);
        document
          .getElementById("addMaStockBtn")
          .addEventListener("click", addMaStock);

        // 设置定时刷新
        updateInterval = setInterval(function () {
          if (monitoring) {
            fetchStocksData();
            fetchMaStocksData();
          }
        }, 5000); // 每5秒刷新一次数据
      });

      // 获取监控状态
      function fetchMonitorStatus() {
        fetch("/api/monitor/status")
          .then((response) => response.json())
          .then((data) => {
            updateMonitoringStatus(data.monitoring);
          })
          .catch((error) => {
            console.error("获取监控状态失败:", error);
          });
      }

      // 更新监控状态UI
      function updateMonitoringStatus(status) {
        monitoring = status;
        const statusIndicator = document.getElementById("systemStatus");
        const startBtn = document.getElementById("startBtn");
        const stopBtn = document.getElementById("stopBtn");

        if (status) {
          statusIndicator.className = "status-indicator status-running";
          statusIndicator.innerHTML =
            '<i class="bi bi-circle-fill"></i> 系统状态: 运行中';
          startBtn.disabled = true;
          stopBtn.disabled = false;
        } else {
          statusIndicator.className = "status-indicator status-stopped";
          statusIndicator.innerHTML =
            '<i class="bi bi-circle-fill"></i> 系统状态: 未运行';
          startBtn.disabled = false;
          stopBtn.disabled = true;
        }
      }

      // 启动监控
      function startMonitoring() {
        fetch("/api/monitor/start", {
          method: "POST",
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              updateMonitoringStatus(true);
              showAlert("监控已启动", "success");
              // 立即刷新数据
              fetchStocksData();
              fetchMaStocksData();
            } else {
              showAlert(data.message, "danger");
            }
          })
          .catch((error) => {
            console.error("启动监控失败:", error);
            showAlert("启动监控失败", "danger");
          });
      }

      // 停止监控
      function stopMonitoring() {
        fetch("/api/monitor/stop", {
          method: "POST",
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              updateMonitoringStatus(false);
              showAlert("监控已停止", "success");
            } else {
              showAlert(data.message, "danger");
            }
          })
          .catch((error) => {
            console.error("停止监控失败:", error);
            showAlert("停止监控失败", "danger");
          });
      }

      // 获取股票列表
      function fetchStocks() {
        fetch("/api/stocks")
          .then((response) => response.json())
          .then((data) => {
            stocks = data;
            fetchStocksData();
          })
          .catch((error) => {
            console.error("获取股票列表失败:", error);
          });
      }

      // 获取均线监控股票列表
      function fetchMaStocks() {
        fetch("/api/ma_stocks")
          .then((response) => response.json())
          .then((data) => {
            maStocks = data;
            fetchMaStocksData();
          })
          .catch((error) => {
            console.error("获取均线监控股票列表失败:", error);
          });
      }

      // 获取股票数据
      function fetchStocksData() {
        fetch("/api/stocks/data")
          .then((response) => response.json())
          .then((data) => {
            renderStockTable(data);
          })
          .catch((error) => {
            console.error("获取股票数据失败:", error);
          });
      }

      // 获取均线监控股票数据
      function fetchMaStocksData() {
        fetch("/api/ma_stocks/data")
          .then((response) => response.json())
          .then((data) => {
            renderMaStockTable(data);
          })
          .catch((error) => {
            console.error("获取均线监控股票数据失败:", error);
          });
      }

      // 添加股票
      function addStock() {
        const code = document.getElementById("stockCode").value.trim();
        const name = document.getElementById("stockName").value.trim();
        const price = parseFloat(document.getElementById("monitorPrice").value);
        const note = document.getElementById("stockNote").value.trim();

        if (!code || !name || isNaN(price)) {
          showAlert("请输入有效的股票代码、名称和监控价格", "danger");
          return;
        }

        fetch("/api/stocks", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            code: code,
            name: name,
            monitor_price: price,
            note: note,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              // 清空输入框
              document.getElementById("stockCode").value = "";
              document.getElementById("stockName").value = "";
              document.getElementById("monitorPrice").value = "";
              document.getElementById("stockNote").value = "";

              // 刷新股票列表和数据
              fetchStocks();
              // 立即获取最新数据并刷新表格
              setTimeout(() => {
                fetchStocksData();
              }, 500);
              showAlert("股票添加成功", "success");
            } else {
              showAlert(data.message, "danger");
            }
          })
          .catch((error) => {
            console.error("添加股票失败:", error);
            showAlert("添加股票失败", "danger");
          });
      }

      // 添加均线监控股票
      function addMaStock() {
        const code = document.getElementById("maStockCode").value.trim();
        const name = document.getElementById("maStockName").value.trim();
        const note = document.getElementById("maStockNote").value.trim();

        if (!code || !name) {
          showAlert("请输入有效的股票代码和名称", "danger");
          return;
        }

        fetch("/api/ma_stocks", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            code: code,
            name: name,
            note: note,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              // 清空输入框
              document.getElementById("maStockCode").value = "";
              document.getElementById("maStockName").value = "";
              document.getElementById("maStockNote").value = "";

              // 刷新均线监控列表和数据
              fetchMaStocks();
              // 立即获取最新数据并刷新表格
              setTimeout(() => {
                fetchMaStocksData();
              }, 500);
              showAlert("均线监控股票添加成功", "success");
            } else {
              showAlert(data.message, "danger");
            }
          })
          .catch((error) => {
            console.error("添加均线监控股票失败:", error);
            showAlert("添加均线监控股票失败", "danger");
          });
      }

      // 渲染股票表格
      function renderStockTable(data) {
        const stockList = document.getElementById("stockTableBody");
        stockList.innerHTML = "";

        if (data.length === 0) {
          const emptyRow = document.createElement("tr");
          emptyRow.innerHTML = `<td colspan="11" style="text-align: center; padding: 2rem;">暂无数据，请添加股票</td>`;
          stockList.appendChild(emptyRow);
          return;
        }

        data.forEach((stock) => {
          const row = document.createElement("tr");

          // 计算涨跌幅的颜色
          const yesterdayChangeClass =
            parseFloat(stock.yesterday_change || 0) >= 0
              ? "positive"
              : "negative";

          // 判断当前价格是否低于监控价格
          const priceClass =
            stock.current_price < stock.monitor_price ? "negative" : "";
          const priceBadge =
            stock.current_price < stock.monitor_price
              ? `<span class="badge badge-danger">低于监控</span>`
              : "";

          // 判断是否为交易时间
          const isTradingTime = isTrading();
          const currentPrice = isTradingTime
            ? stock.current_price
            : "非交易时间";
          const currentPriceDisplay = isTradingTime
            ? `<strong>${formatNumber(
                stock.current_price
              )}</strong> ${priceBadge}`
            : `<span class="badge badge-warning">非交易时间</span>`;

          row.innerHTML = `
            <td><strong>${stock.name}</strong><br><small>${
            stock.code
          }</small></td>
            <td class="${yesterdayChangeClass}">${formatNumber(
            stock.yesterday_change || 0
          )}%</td>
            <td>${formatNumber(stock.close_price || 0)}</td>
            <td>${formatNumber(stock.today_change || 0)}%</td>
            <td class="${priceClass}">${currentPriceDisplay}</td>
            <td>
              <input type="number" class="monitor-price-input" data-code="${
                stock.code
              }" 
                value="${stock.monitor_price}" step="0.01">
            </td>
            <td>${stock.note || ""}</td>
            <td>
              <button class="action-btn update-btn" data-code="${stock.code}">
                <i class="bi bi-pencil"></i> 修改
              </button>
              <button class="action-btn delete-btn" data-code="${
                stock.code
              }" data-name="${stock.name}">
                <i class="bi bi-trash"></i> 删除
              </button>
            </td>
          `;

          stockList.appendChild(row);
        });

        // 绑定修改监控价格事件
        document.querySelectorAll(".update-btn").forEach((button) => {
          button.addEventListener("click", function () {
            const code = this.dataset.code;
            const input = document.querySelector(
              `.monitor-price-input[data-code="${code}"]`
            );
            const price = parseFloat(input.value);

            if (isNaN(price)) {
              showAlert("请输入有效的价格", "danger");
              return;
            }

            updateMonitorPrice(code, price);
          });
        });

        // 绑定删除按钮事件
        document.querySelectorAll(".delete-btn").forEach((button) => {
          button.addEventListener("click", function () {
            const code = this.dataset.code;
            const name = this.dataset.name;
            if (confirm(`确定要删除股票 ${name} 吗？`)) {
              deleteStock(code);
            }
          });
        });
      }

      // 渲染均线监控表格
      function renderMaStockTable(data) {
        const maStockList = document.getElementById("maStockList");
        maStockList.innerHTML = "";

        if (data.length === 0) {
          const emptyRow = document.createElement("tr");
          emptyRow.innerHTML = `<td colspan="12" style="text-align: center; padding: 2rem;">暂无数据，请添加股票</td>`;
          maStockList.appendChild(emptyRow);
          return;
        }

        data.forEach((stock) => {
          const row = document.createElement("tr");

          // 计算涨跌幅的颜色
          const yesterdayChangeClass =
            parseFloat(stock.yesterday_change || 0) >= 0
              ? "positive"
              : "negative";

          // 计算距离5日均线
          const distanceToMa5 = (stock.current_price || 0) - (stock.ma5 || 0);
          const distanceClass = distanceToMa5 < 0 ? "negative" : "positive";

          // 添加标签
          const distanceBadge =
            distanceToMa5 < 0
              ? `<span class="badge badge-danger">低于均线</span>`
              : `<span class="badge badge-success">高于均线</span>`;

          // 判断是否为交易时间
          const isTradingTime = isTrading();
          const currentPrice = isTradingTime
            ? stock.current_price
            : "非交易时间";
          const currentPriceDisplay = isTradingTime
            ? `<strong>${formatNumber(stock.current_price)}</strong>`
            : `<span class="badge badge-warning">非交易时间</span>`;

          row.innerHTML = `
            <td><strong>${stock.name}</strong></td>
            <td>${formatMainForceNet(stock.main_force_net)}</td>
            <td class="${yesterdayChangeClass}">${formatNumber(
            stock.yesterday_change || 0
          )}%</td>
            <td>${formatNumber(stock.open_price || 0)}</td>
            <td>${formatNumber(stock.close_price || 0)}</td>
            <td>${formatNumber(stock.turnover_rate || 0)}%</td>
            <td>${formatNumber(stock.ma5 || 0)}</td>
            <td>${formatNumber(stock.ma10 || 0)}</td>
            <td class="${distanceClass}">
              ${formatNumber(distanceToMa5)} ${distanceBadge}
            </td>
            <td>${currentPriceDisplay}</td>
            <td>${stock.note || ""}</td>
            <td>
              <button class="action-btn delete-btn" data-code="${stock.code}">
                <i class="bi bi-trash"></i> 删除
              </button>
            </td>
          `;

          maStockList.appendChild(row);
        });

        // 绑定删除按钮事件
        document
          .querySelectorAll("#maStockList .delete-btn")
          .forEach((button) => {
            button.addEventListener("click", function () {
              const code = this.dataset.code;
              if (confirm("确定要删除这只股票吗？")) {
                deleteMaStock(code);
              }
            });
          });
      }

      // 更新监控价格
      function updateMonitorPrice(code, price) {
        fetch(`/api/stocks/${code}/monitor-price`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            monitor_price: price,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              // 刷新股票列表
              fetchStocksData();
              showAlert("监控价格更新成功", "success");
            } else {
              showAlert(data.message, "danger");
            }
          })
          .catch((error) => {
            console.error("更新监控价格失败:", error);
            showAlert("更新监控价格失败", "danger");
          });
      }

      // 删除股票
      function deleteStock(code) {
        fetch(`/api/stocks/${code}`, {
          method: "DELETE",
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              // 刷新股票列表
              fetchStocks();
              showAlert("股票删除成功", "success");
            } else {
              showAlert(data.message, "danger");
            }
          })
          .catch((error) => {
            console.error("删除股票失败:", error);
            showAlert("删除股票失败", "danger");
          });
      }

      // 删除均线监控股票
      function deleteMaStock(code) {
        fetch(`/api/ma_stocks/${code}`, {
          method: "DELETE",
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              // 刷新均线监控列表
              fetchMaStocks();
              showAlert("均线监控股票删除成功", "success");
            } else {
              showAlert(data.message, "danger");
            }
          })
          .catch((error) => {
            console.error("删除均线监控股票失败:", error);
            showAlert("删除均线监控股票失败", "danger");
          });
      }

      // 格式化数字
      function formatNumber(num) {
        return parseFloat(num).toFixed(2);
      }

      // 格式化主力净量
      function formatMainForceNet(value) {
        if (value === "暂无数据") return value;

        const num = parseFloat(value);
        if (isNaN(num)) return value;

        // 转换为万元单位
        const formattedValue = (num / 10000).toFixed(2);
        const colorClass = num >= 0 ? "positive" : "negative";

        return `<span class="${colorClass}">${formattedValue}万</span>`;
      }

      // 判断是否为交易时间
      function isTrading() {
        const now = new Date();
        const day = now.getDay();
        const hours = now.getHours();
        const minutes = now.getMinutes();
        const time = hours * 100 + minutes;

        // 周末不交易
        if (day === 0 || day === 6) return false;

        // 交易时间：9:30-11:30, 13:00-15:00
        return (time >= 930 && time <= 1130) || (time >= 1300 && time <= 1500);
      }

      // 显示提示信息
      function showAlert(message, type) {
        // 创建提示元素
        const alertDiv = document.createElement("div");
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.style.position = "fixed";
        alertDiv.style.top = "20px";
        alertDiv.style.right = "20px";
        alertDiv.style.zIndex = "9999";
        alertDiv.style.maxWidth = "300px";

        alertDiv.innerHTML = `
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;

        // 添加到页面
        document.body.appendChild(alertDiv);

        // 3秒后自动关闭
        setTimeout(() => {
          alertDiv.classList.remove("show");
          setTimeout(() => {
            document.body.removeChild(alertDiv);
          }, 150);
        }, 3000);
      }
    </script>
  </body>
</html>
